<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ArtifactorySearch.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Dependency-Check Build-Reporting</a> &gt; <a href="../index.html" class="el_bundle">dependency-check-core</a> &gt; <a href="index.source.html" class="el_package">org.owasp.dependencycheck.data.artifactory</a> &gt; <span class="el_source">ArtifactorySearch.java</span></div><h1>ArtifactorySearch.java</h1><pre class="source lang-java linenums">/*
 * This file is part of dependency-check-core.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Copyright (c) 2018 Nicolas Henneaux. All Rights Reserved.
 */
package org.owasp.dependencycheck.data.artifactory;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.JsonPrimitive;
import org.owasp.dependencycheck.data.nexus.MavenArtifact;
import org.owasp.dependencycheck.dependency.Dependency;
import org.owasp.dependencycheck.utils.Checksum;
import org.owasp.dependencycheck.utils.InvalidSettingException;
import org.owasp.dependencycheck.utils.Settings;
import org.owasp.dependencycheck.utils.URLConnectionFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.annotation.concurrent.ThreadSafe;
import javax.xml.bind.DatatypeConverter;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Class of methods to search Artifactory for hashes and determine Maven GAV
 * from there.
 *
 * @author nhenneaux
 */
@ThreadSafe
public class ArtifactorySearch {

    /**
     * Used for logging.
     */
<span class="nc" id="L61">    private static final Logger LOGGER = LoggerFactory.getLogger(ArtifactorySearch.class);</span>

    /**
     * Pattern to match the path returned by the Artifactory AQL API.
     */
<span class="nc" id="L66">    private static final Pattern PATH_PATTERN = Pattern.compile(&quot;^/(?&lt;groupId&gt;.+)/(?&lt;artifactId&gt;[^/]+)/(?&lt;version&gt;[^/]+)/[^/]+$&quot;);</span>
    /**
     * Extracted duplicateArtifactorySearchIT.java comment.
     */
    private static final String WHILE_ACTUAL_IS = &quot; while actual is &quot;;
    /**
     * The URL for the Central service.
     */
    private final String rootURL;

    /**
     * Whether to use the Proxy when making requests.
     */
    private final boolean useProxy;

    /**
     * The configured settings.
     */
    private final Settings settings;

    /**
     * Creates a NexusSearch for the given repository URL.
     *
     * @param settings the configured settings
     */
<span class="nc" id="L91">    public ArtifactorySearch(Settings settings) {</span>
<span class="nc" id="L92">        this.settings = settings;</span>

<span class="nc" id="L94">        final String searchUrl = settings.getString(Settings.KEYS.ANALYZER_ARTIFACTORY_URL);</span>

<span class="nc" id="L96">        this.rootURL = searchUrl;</span>
<span class="nc" id="L97">        LOGGER.debug(&quot;Artifactory Search URL {}&quot;, searchUrl);</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (null != settings.getString(Settings.KEYS.PROXY_SERVER)) {</span>
<span class="nc" id="L100">            boolean useProxySettings = false;</span>
            try {
<span class="nc" id="L102">                useProxySettings = settings.getBoolean(Settings.KEYS.ANALYZER_ARTIFACTORY_USES_PROXY);</span>
<span class="nc" id="L103">            } catch (InvalidSettingException e) {</span>
<span class="nc" id="L104">                LOGGER.error(&quot;Settings {} is invalid, only, true/false is valid&quot;, Settings.KEYS.ANALYZER_ARTIFACTORY_USES_PROXY, e);</span>
<span class="nc" id="L105">            }</span>
<span class="nc" id="L106">            this.useProxy = useProxySettings;</span>
<span class="nc" id="L107">            LOGGER.debug(&quot;Using proxy? {}&quot;, useProxy);</span>
<span class="nc" id="L108">        } else {</span>
<span class="nc" id="L109">            useProxy = false;</span>
<span class="nc" id="L110">            LOGGER.debug(&quot;Not using proxy&quot;);</span>
        }
<span class="nc" id="L112">    }</span>

    /**
     * Searches the configured Central URL for the given hash (MD5, SHA1 and
     * SHA256). If the artifact is found, a &lt;code&gt;MavenArtifact&lt;/code&gt; is
     * populated with the GAV.
     *
     * @param dependency the dependency for which to search (search is based on
     * hashes)
     * @return the populated Maven GAV.
     * @throws FileNotFoundException if the specified artifact is not found
     * @throws IOException if it's unable to connect to the specified repository
     */
    public List&lt;MavenArtifact&gt; search(Dependency dependency) throws IOException {

<span class="nc" id="L127">        final String sha1sum = dependency.getSha1sum();</span>
<span class="nc" id="L128">        final URL url = buildUrl(sha1sum);</span>
<span class="nc" id="L129">        final HttpURLConnection conn = connect(url);</span>
<span class="nc" id="L130">        final int responseCode = conn.getResponseCode();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (responseCode == 200) {</span>
<span class="nc" id="L132">            return processResponse(dependency, conn);</span>
        }
<span class="nc" id="L134">        throw new IOException(&quot;Could not connect to Artifactory &quot; + url + &quot; (&quot; + responseCode + &quot;): &quot; + conn.getResponseMessage());</span>

    }

    /**
     * Makes an connection to the given URL.
     *
     * @param url the URL to connect to
     * @return the HTTP URL Connection
     * @throws IOException thrown if there is an error making the connection
     */
    private HttpURLConnection connect(URL url) throws IOException {
<span class="nc" id="L146">        LOGGER.debug(&quot;Searching Artifactory url {}&quot;, url);</span>

        // Determine if we need to use a proxy. The rules:
        // 1) If the proxy is set, AND the setting is set to true, use the proxy
        // 2) Otherwise, don't use the proxy (either the proxy isn't configured,
        // or proxy is specifically set to false)
<span class="nc" id="L152">        final URLConnectionFactory factory = new URLConnectionFactory(settings);</span>
<span class="nc" id="L153">        final HttpURLConnection conn = factory.createHttpURLConnection(url, useProxy);</span>
<span class="nc" id="L154">        conn.setDoOutput(true);</span>

<span class="nc" id="L156">        conn.addRequestProperty(&quot;X-Result-Detail&quot;, &quot;info&quot;);</span>

<span class="nc" id="L158">        final String username = settings.getString(Settings.KEYS.ANALYZER_ARTIFACTORY_API_USERNAME);</span>
<span class="nc" id="L159">        final String apiToken = settings.getString(Settings.KEYS.ANALYZER_ARTIFACTORY_API_TOKEN);</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">        if (username != null &amp;&amp; apiToken != null) {</span>
<span class="nc" id="L161">            final String userpassword = username + &quot;:&quot; + apiToken;</span>
<span class="nc" id="L162">            final String encodedAuthorization = DatatypeConverter.printBase64Binary(userpassword.getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L163">            conn.addRequestProperty(&quot;Authorization&quot;, &quot;Basic &quot; + encodedAuthorization);</span>
<span class="nc" id="L164">        } else {</span>
<span class="nc" id="L165">            final String bearerToken = settings.getString(Settings.KEYS.ANALYZER_ARTIFACTORY_BEARER_TOKEN);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (bearerToken != null) {</span>
<span class="nc" id="L167">                conn.addRequestProperty(&quot;Authorization&quot;, &quot;Bearer &quot; + bearerToken);</span>
            }
        }

<span class="nc" id="L171">        conn.connect();</span>
<span class="nc" id="L172">        return conn;</span>
    }

    /**
     * Constructs the URL using the SHA1 checksum.
     *
     * @param sha1sum the SHA1 checksum
     * @return the API URL to search for the given checksum
     * @throws MalformedURLException thrown if the URL is malformed
     */
    private URL buildUrl(String sha1sum) throws MalformedURLException {
        // TODO Investigate why sha256 parameter is not working
        // API defined https://www.jfrog.com/confluence/display/RTF/Artifactory+REST+API#ArtifactoryRESTAPI-ChecksumSearch
<span class="nc" id="L185">        return new URL(rootURL + &quot;/api/search/checksum?sha1=&quot; + sha1sum);</span>
    }

    /**
     * Process the Artifactory response.
     *
     * @param dependency the dependency
     * @param conn the HTTP URL Connection
     * @return a list of the Maven Artifact information
     * @throws IOException thrown if there is an I/O error
     */
    protected List&lt;MavenArtifact&gt; processResponse(Dependency dependency, HttpURLConnection conn) throws IOException {
        final JsonObject asJsonObject;
<span class="nc" id="L198">        try (final InputStreamReader streamReader = new InputStreamReader(conn.getInputStream(), StandardCharsets.UTF_8)) {</span>
<span class="nc" id="L199">            asJsonObject = new JsonParser().parse(streamReader).getAsJsonObject();</span>
        }
<span class="nc" id="L201">        final JsonArray results = asJsonObject.getAsJsonArray(&quot;results&quot;);</span>
<span class="nc" id="L202">        final int numFound = results.size();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (numFound == 0) {</span>
<span class="nc" id="L204">            throw new FileNotFoundException(&quot;Artifact &quot; + dependency + &quot; not found in Artifactory&quot;);</span>
        }

<span class="nc" id="L207">        final List&lt;MavenArtifact&gt; result = new ArrayList&lt;&gt;(numFound);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        for (JsonElement jsonElement : results) {</span>

<span class="nc" id="L210">            final JsonObject checksumList = jsonElement.getAsJsonObject().getAsJsonObject(&quot;checksums&quot;);</span>
<span class="nc" id="L211">            final JsonPrimitive sha256Primitive = checksumList.getAsJsonPrimitive(&quot;sha256&quot;);</span>
<span class="nc" id="L212">            final String sha1 = checksumList.getAsJsonPrimitive(&quot;sha1&quot;).getAsString();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">            final String sha256 = sha256Primitive == null ? null : sha256Primitive.getAsString();</span>
<span class="nc" id="L214">            final String md5 = checksumList.getAsJsonPrimitive(&quot;md5&quot;).getAsString();</span>

<span class="nc" id="L216">            checkHashes(dependency, sha1, sha256, md5);</span>

<span class="nc" id="L218">            final String downloadUri = jsonElement.getAsJsonObject().getAsJsonPrimitive(&quot;downloadUri&quot;).getAsString();</span>

<span class="nc" id="L220">            final String path = jsonElement.getAsJsonObject().getAsJsonPrimitive(&quot;path&quot;).getAsString();</span>

<span class="nc" id="L222">            final Matcher pathMatcher = PATH_PATTERN.matcher(path);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (!pathMatcher.matches()) {</span>
<span class="nc" id="L224">                throw new IllegalStateException(&quot;Cannot extract the Maven information from the apth retrieved in Artifactory &quot; + path);</span>
            }
<span class="nc" id="L226">            final String groupId = pathMatcher.group(&quot;groupId&quot;).replace('/', '.');</span>
<span class="nc" id="L227">            final String artifactId = pathMatcher.group(&quot;artifactId&quot;);</span>
<span class="nc" id="L228">            final String version = pathMatcher.group(&quot;version&quot;);</span>

<span class="nc" id="L230">            result.add(new MavenArtifact(groupId, artifactId, version, downloadUri, MavenArtifact.derivePomUrl(artifactId, version, downloadUri)));</span>
<span class="nc" id="L231">        }</span>

<span class="nc" id="L233">        return result;</span>
    }

    /**
     * Validates the hashes of the dependency.
     *
     * @param dependency the dependency
     * @param sha1 the SHA1 checksum
     * @param sha256 the SHA256 checksum
     * @param md5 the MD5 checksum
     * @throws FileNotFoundException thrown if one of the checksums does not
     * match
     */
    private void checkHashes(Dependency dependency, String sha1, String sha256, String md5) throws FileNotFoundException {
<span class="nc" id="L247">        final String md5sum = dependency.getMd5sum();</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!md5.equals(md5sum)) {</span>
<span class="nc" id="L249">            throw new FileNotFoundException(&quot;Artifact found by API is not matching the md5 &quot;</span>
                    + &quot;of the artifact (repository hash is &quot; + md5 + WHILE_ACTUAL_IS + md5sum + &quot;) !&quot;);
        }
<span class="nc" id="L252">        final String sha1sum = dependency.getSha1sum();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (!sha1.equals(sha1sum)) {</span>
<span class="nc" id="L254">            throw new FileNotFoundException(&quot;Artifact found by API is not matching the SHA1 &quot;</span>
                    + &quot;of the artifact (repository hash is &quot; + sha1 + WHILE_ACTUAL_IS + sha1sum + &quot;) !&quot;);
        }
<span class="nc" id="L257">        final String sha256sum = dependency.getSha256sum();</span>
<span class="nc bnc" id="L258" title="All 4 branches missed.">        if (sha256 != null &amp;&amp; !sha256.equals(sha256sum)) {</span>
<span class="nc" id="L259">            throw new FileNotFoundException(&quot;Artifact found by API is not matching the SHA-256 &quot;</span>
                    + &quot;of the artifact (repository hash is &quot; + sha256 + WHILE_ACTUAL_IS + sha256sum + &quot;) !&quot;);
        }
<span class="nc" id="L262">    }</span>

    /**
     * Performs a pre-flight request to ensure the Artifactory service is
     * reachable.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if Artifactory could be reached; otherwise
     * &lt;code&gt;false&lt;/code&gt;.
     */
    public boolean preflightRequest() {
        try {
<span class="nc" id="L273">            final URL url = buildUrl(Checksum.getSHA1Checksum(UUID.randomUUID().toString()));</span>
<span class="nc" id="L274">            final HttpURLConnection connection = connect(url);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (connection.getResponseCode() != 200) {</span>
<span class="nc" id="L276">                LOGGER.warn(&quot;Expected 200 result from Artifactory ({}), got {}&quot;, url, connection.getResponseCode());</span>
<span class="nc" id="L277">                return false;</span>
            }
<span class="nc" id="L279">            return true;</span>
<span class="nc" id="L280">        } catch (IOException e) {</span>
<span class="nc" id="L281">            LOGGER.error(&quot;Cannot connect to Artifactory&quot;, e);</span>
<span class="nc" id="L282">            return false;</span>
        }

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>