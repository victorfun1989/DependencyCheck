<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CPEHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Dependency-Check Command Line</a> &gt; <a href="../index.html" class="el_bundle">dependency-check-core</a> &gt; <a href="index.source.html" class="el_package">org.owasp.dependencycheck.data.update.cpe</a> &gt; <span class="el_source">CPEHandler.java</span></div><h1>CPEHandler.java</h1><pre class="source lang-java linenums">/*
 * This file is part of dependency-check-core.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Copyright (c) 2015 Jeremy Long. All Rights Reserved.
 */
package org.owasp.dependencycheck.data.update.cpe;

import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.List;
import javax.annotation.concurrent.NotThreadSafe;
import org.owasp.dependencycheck.data.update.exception.InvalidDataException;
import org.owasp.dependencycheck.utils.Settings;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xml.sax.Attributes;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.DefaultHandler;

/**
 * A SAX Handler that will parse the CPE XML and load it into the database.
 *
 * @author Jeremy Long
 */
@NotThreadSafe
public class CPEHandler extends DefaultHandler {

    /**
     * The current CPE schema.
     */
    private static final String CURRENT_SCHEMA_VERSION = &quot;2.3&quot;;
    /**
     * The Starts with expression to filter CVE entries by CPE.
     */
    private final String cpeStartsWith;
    /**
     * The text content of the node being processed. This can be used during the
     * end element event.
     */
<span class="nc" id="L52">    private StringBuilder nodeText = null;</span>
    /**
     * A reference to the current element.
     */
<span class="nc" id="L56">    private final Element current = new Element();</span>
    /**
     * The logger.
     */
<span class="nc" id="L60">    private static final Logger LOGGER = LoggerFactory.getLogger(CPEHandler.class);</span>
    /**
     * The list of CPE values.
     */
<span class="nc" id="L64">    private final List&lt;Cpe&gt; data = new ArrayList&lt;&gt;();</span>

    /**
     * Constructs a new CPE Handler object with the configured settings.
     *
     * @param settings the configured settings
     */
<span class="nc" id="L71">    public CPEHandler(Settings settings) {</span>
<span class="nc" id="L72">        cpeStartsWith = settings.getString(Settings.KEYS.CVE_CPE_STARTS_WITH_FILTER, &quot;cpe:/a:&quot;);</span>
<span class="nc" id="L73">    }</span>

    /**
     * Returns the list of CPE values.
     *
     * @return the list of CPE values
     */
    public List&lt;Cpe&gt; getData() {
<span class="nc" id="L81">        return data;</span>
    }

    /**
     * Handles the start element event.
     *
     * @param uri the elements uri
     * @param localName the local name
     * @param qName the qualified name
     * @param attributes the attributes
     * @throws SAXException thrown if there is an exception processing the
     * element
     */
    @Override
    public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
<span class="nc" id="L96">        nodeText = null;</span>
<span class="nc" id="L97">        current.setNode(qName);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (current.isCpeItemNode()) {</span>
<span class="nc" id="L99">            final String temp = attributes.getValue(&quot;deprecated&quot;);</span>
<span class="nc" id="L100">            final String value = attributes.getValue(&quot;name&quot;);</span>
<span class="nc" id="L101">            final boolean delete = &quot;true&quot;.equalsIgnoreCase(temp);</span>
<span class="nc bnc" id="L102" title="All 6 branches missed.">            if (!delete &amp;&amp; value.startsWith(cpeStartsWith) &amp;&amp; value.length() &gt; 7) {</span>
                try {
<span class="nc" id="L104">                    final Cpe cpe = new Cpe(value);</span>
<span class="nc" id="L105">                    data.add(cpe);</span>
<span class="nc" id="L106">                } catch (UnsupportedEncodingException ex) {</span>
<span class="nc" id="L107">                    LOGGER.debug(&quot;Unable to parse the CPE&quot;, ex);</span>
<span class="nc" id="L108">                } catch (InvalidDataException ex) {</span>
<span class="nc" id="L109">                    LOGGER.debug(&quot;CPE is not the correct format&quot;, ex);</span>
<span class="nc" id="L110">                }</span>
            }
<span class="nc bnc" id="L112" title="All 2 branches missed.">        } else if (current.isSchemaVersionNode()) {</span>
<span class="nc" id="L113">            nodeText = new StringBuilder(3);</span>
        }
//        } else if (current.isTitleNode()) {
//            //do nothing
//        } else if (current.isMetaNode()) {
//            //do nothing
//        } else if (current.isTimestampNode()) {
//            //do nothing
//        } else if (current.isCpeListNode()) {
//            //do nothing
//        } else if (current.isNotesNode()) {
//            //do nothing
//        } else if (current.isNoteNode()) {
//            //do nothing
//        } else if (current.isCheckNode()) {
//            //do nothing
//        } else if (current.isGeneratorNode()) {
//            //do nothing
//        } else if (current.isProductNameNode()) {
//            //do nothing
//        } else if (current.isProductVersionNode()) {
//            //do nothing
<span class="nc" id="L135">    }</span>

    /**
     * Reads the characters in the current node.
     *
     * @param ch the char array
     * @param start the start position of the data read
     * @param length the length of the data read
     * @throws SAXException thrown if there is an exception processing the
     * characters
     */
    @Override
    public void characters(char[] ch, int start, int length) throws SAXException {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (nodeText != null) {</span>
<span class="nc" id="L149">            nodeText.append(ch, start, length);</span>
        }
<span class="nc" id="L151">    }</span>

    /**
     * Handles the end element event. Stores the CPE data in the Cve Database if
     * the cpe item node is ending.
     *
     * @param uri the element's uri
     * @param localName the local name
     * @param qName the qualified name
     * @throws SAXException thrown if there is an exception processing the
     * element
     */
    @Override
    public void endElement(String uri, String localName, String qName) throws SAXException {
<span class="nc" id="L165">        current.setNode(qName);</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">        if (current.isSchemaVersionNode() &amp;&amp; !CURRENT_SCHEMA_VERSION.equals(nodeText.toString())) {</span>
<span class="nc" id="L167">            throw new SAXException(&quot;ERROR: Unexpected CPE Schema Version, expected: &quot;</span>
                    + CURRENT_SCHEMA_VERSION + &quot;, file is: &quot; + nodeText);

        }
<span class="nc" id="L171">    }</span>

    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;The Element Class that maintains state information about the current node&quot;&gt;
    /**
     * A simple class to maintain information about the current element while
     * parsing the CPE XML.
     */
<span class="nc" id="L178">    protected static final class Element {</span>

        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String CPE_LIST = &quot;cpe-list&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String CPE_ITEM = &quot;cpe-item&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String TITLE = &quot;title&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String NOTES = &quot;notes&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String NOTE = &quot;note&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String CHECK = &quot;check&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String META = &quot;meta:item-metadata&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String GENERATOR = &quot;generator&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String PRODUCT_NAME = &quot;product_name&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String PRODUCT_VERSION = &quot;product_version&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String SCHEMA_VERSION = &quot;schema_version&quot;;
        /**
         * A node type in the CPE Schema 2.2
         */
        public static final String TIMESTAMP = &quot;timestamp&quot;;
        /**
         * A reference to the current node.
         */
<span class="nc" id="L231">        private String node = null;</span>

        /**
         * Gets the value of node
         *
         * @return the value of node
         */
        public String getNode() {
<span class="nc" id="L239">            return this.node;</span>
        }

        /**
         * Sets the value of node
         *
         * @param node new value of node
         */
        public void setNode(String node) {
<span class="nc" id="L248">            this.node = node;</span>
<span class="nc" id="L249">        }</span>

        /**
         * Checks if the handler is at the CPE_LIST node
         *
         * @return true or false
         */
        public boolean isCpeListNode() {
<span class="nc" id="L257">            return CPE_LIST.equals(node);</span>
        }

        /**
         * Checks if the handler is at the CPE_ITEM node
         *
         * @return true or false
         */
        public boolean isCpeItemNode() {
<span class="nc" id="L266">            return CPE_ITEM.equals(node);</span>
        }

        /**
         * Checks if the handler is at the TITLE node
         *
         * @return true or false
         */
        public boolean isTitleNode() {
<span class="nc" id="L275">            return TITLE.equals(node);</span>
        }

        /**
         * Checks if the handler is at the NOTES node
         *
         * @return true or false
         */
        public boolean isNotesNode() {
<span class="nc" id="L284">            return NOTES.equals(node);</span>
        }

        /**
         * Checks if the handler is at the NOTE node
         *
         * @return true or false
         */
        public boolean isNoteNode() {
<span class="nc" id="L293">            return NOTE.equals(node);</span>
        }

        /**
         * Checks if the handler is at the CHECK node
         *
         * @return true or false
         */
        public boolean isCheckNode() {
<span class="nc" id="L302">            return CHECK.equals(node);</span>
        }

        /**
         * Checks if the handler is at the META node
         *
         * @return true or false
         */
        public boolean isMetaNode() {
<span class="nc" id="L311">            return META.equals(node);</span>
        }

        /**
         * Checks if the handler is at the GENERATOR node
         *
         * @return true or false
         */
        public boolean isGeneratorNode() {
<span class="nc" id="L320">            return GENERATOR.equals(node);</span>
        }

        /**
         * Checks if the handler is at the PRODUCT_NAME node
         *
         * @return true or false
         */
        public boolean isProductNameNode() {
<span class="nc" id="L329">            return PRODUCT_NAME.equals(node);</span>
        }

        /**
         * Checks if the handler is at the PRODUCT_VERSION node
         *
         * @return true or false
         */
        public boolean isProductVersionNode() {
<span class="nc" id="L338">            return PRODUCT_VERSION.equals(node);</span>
        }

        /**
         * Checks if the handler is at the SCHEMA_VERSION node
         *
         * @return true or false
         */
        public boolean isSchemaVersionNode() {
<span class="nc" id="L347">            return SCHEMA_VERSION.equals(node);</span>
        }

        /**
         * Checks if the handler is at the TIMESTAMP node
         *
         * @return true or false
         */
        public boolean isTimestampNode() {
<span class="nc" id="L356">            return TIMESTAMP.equals(node);</span>
        }
    }
    // &lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>